(function(e){typeof define==="function"&&define.amd?define(["jquery","jquery.ui.widget"],e):e(window.jQuery)})(function(e){e.support.xhrFileUpload=!!(window.XMLHttpRequestUpload&&window.FileReader);e.support.xhrFormDataFileUpload=!!window.FormData;e.widget("blueimp.fileupload",{options:{namespace:undefined,dropZone:e(document),pasteZone:e(document),fileInput:undefined,replaceFileInput:true,paramName:undefined,singleFileUploads:true,limitMultiFileUploads:undefined,sequentialUploads:false,limitConcurrentUploads:undefined,
forceIframeTransport:false,redirect:undefined,redirectParamName:undefined,postMessage:undefined,multipart:true,maxChunkSize:undefined,uploadedBytes:undefined,recalculateProgress:true,progressInterval:100,bitrateInterval:500,formData:function(a){return a.serializeArray()},add:function(a,b){b.submit()},processData:false,contentType:false,cache:false},_refreshOptionsList:["namespace","fileInput","dropZone","pasteZone","multipart","forceIframeTransport"],_BitrateTimer:function(){this.timestamp=+new Date;
this.bitrate=this.loaded=0;this.getBitrate=function(a,b,c){var d=a-this.timestamp;if(!this.bitrate||!c||d>c){this.bitrate=(b-this.loaded)*(1E3/d)*8;this.loaded=b;this.timestamp=a}return this.bitrate}},_isXHRUpload:function(a){return!a.forceIframeTransport&&(!a.multipart&&e.support.xhrFileUpload||e.support.xhrFormDataFileUpload)},_getFormData:function(a){var b;if(typeof a.formData==="function")return a.formData(a.form);if(e.isArray(a.formData))return a.formData;if(a.formData){b=[];e.each(a.formData,
function(c,d){b.push({name:c,value:d})});return b}return[]},_getTotal:function(a){var b=0;e.each(a,function(c,d){b+=d.size||1});return b},_onProgress:function(a,b){if(a.lengthComputable){var c=+new Date,d,f;if(!(b._time&&b.progressInterval&&c-b._time<b.progressInterval&&a.loaded!==a.total)){b._time=c;d=b.total||this._getTotal(b.files);f=parseInt(a.loaded/a.total*(b.chunkSize||d),10)+(b.uploadedBytes||0);this._loaded+=f-(b.loaded||b.uploadedBytes||0);b.lengthComputable=true;b.loaded=f;b.total=d;b.bitrate=
b._bitrateTimer.getBitrate(c,f,b.bitrateInterval);this._trigger("progress",a,b);this._trigger("progressall",a,{lengthComputable:true,loaded:this._loaded,total:this._total,bitrate:this._bitrateTimer.getBitrate(c,this._loaded,b.bitrateInterval)})}}},_initProgressListener:function(a){var b=this,c=a.xhr?a.xhr():e.ajaxSettings.xhr();if(c.upload){e(c.upload).bind("progress",function(d){var f=d.originalEvent;d.lengthComputable=f.lengthComputable;d.loaded=f.loaded;d.total=f.total;b._onProgress(d,a)});a.xhr=
function(){return c}}},_initXHRData:function(a){var b,c=a.files[0],d=a.multipart||!e.support.xhrFileUpload,f=a.paramName[0];if(!d||a.blob){a.headers=e.extend(a.headers,{"X-File-Name":c.name,"X-File-Type":c.type,"X-File-Size":c.size});if(a.blob){if(!d){a.contentType="application/octet-stream";a.data=a.blob}}else{a.contentType=c.type;a.data=c}}if(d&&e.support.xhrFormDataFileUpload){if(a.postMessage){b=this._getFormData(a);a.blob?b.push({name:f,value:a.blob}):e.each(a.files,function(h,g){b.push({name:a.paramName[h]||
f,value:g})})}else{if(a.formData instanceof FormData)b=a.formData;else{b=new FormData;e.each(this._getFormData(a),function(h,g){b.append(g.name,g.value)})}a.blob?b.append(f,a.blob,c.name):e.each(a.files,function(h,g){if(g instanceof Blob)b.append(a.paramName[h]||f,g,g.name)})}a.data=b}a.blob=null},_initIframeSettings:function(a){a.dataType="iframe "+(a.dataType||"");a.formData=this._getFormData(a);if(a.redirect&&e("<a></a>").prop("href",a.url).prop("host")!==location.host)a.formData.push({name:a.redirectParamName||
"redirect",value:a.redirect})},_initDataSettings:function(a){if(this._isXHRUpload(a)){if(!this._chunkedUpload(a,true)){a.data||this._initXHRData(a);this._initProgressListener(a)}if(a.postMessage)a.dataType="postmessage "+(a.dataType||"")}else this._initIframeSettings(a,"iframe")},_getParamName:function(a){var b=e(a.fileInput),c=a.paramName;if(c)e.isArray(c)||(c=[c]);else{c=[];b.each(function(){var d=e(this),f=d.prop("name")||"files[]";for(d=(d.prop("files")||[1]).length;d;){c.push(f);d-=1}});c.length||
(c=[b.prop("name")||"files[]"])}return c},_initFormSettings:function(a){if(!a.form||!a.form.length){a.form=e(a.fileInput.prop("form"));if(!a.form.length)a.form=e(this.options.fileInput.prop("form"))}a.paramName=this._getParamName(a);if(!a.url)a.url=a.form.prop("action")||location.href;a.type=(a.type||a.form.prop("method")||"").toUpperCase();if(a.type!=="POST"&&a.type!=="PUT")a.type="POST";if(!a.formAcceptCharset)a.formAcceptCharset=a.form.attr("accept-charset")},_getAJAXSettings:function(a){a=e.extend({},
this.options,a);this._initFormSettings(a);this._initDataSettings(a);return a},_enhancePromise:function(a){a.success=a.done;a.error=a.fail;a.complete=a.always;return a},_getXHRPromise:function(a,b,c){var d=e.Deferred(),f=d.promise();b=b||this.options.context||f;if(a===true)d.resolveWith(b,c);else a===false&&d.rejectWith(b,c);f.abort=d.promise;return this._enhancePromise(f)},_chunkedUpload:function(a,b){var c=this,d=a.files[0],f=d.size,h=a.uploadedBytes=a.uploadedBytes||0,g=a.maxChunkSize||f,j=d.slice||
d.webkitSlice||d.mozSlice,k,l,m;if(!(this._isXHRUpload(a)&&j&&(h||g<f))||a.data)return false;if(b)return true;if(h>=f){d.error="Uploaded bytes exceed file size";return this._getXHRPromise(false,a.context,[null,"error",d.error])}l=Math.ceil((f-h)/g);k=function(n){if(!n)return c._getXHRPromise(true,a.context);return k(n-=1).pipe(function(){var i=e.extend({},a);i.blob=j.call(d,h+n*g,h+(n+1)*g);i.chunkIndex=n;i.chunksNumber=l;i.chunkSize=i.blob.size;c._initXHRData(i);c._initProgressListener(i);return m=
(e.ajax(i)||c._getXHRPromise(false,i.context)).done(function(){i.loaded||c._onProgress(e.Event("progress",{lengthComputable:true,loaded:i.chunkSize,total:i.chunkSize}),i);a.uploadedBytes=i.uploadedBytes+=i.chunkSize})})};b=k(l);b.abort=function(){return m.abort()};return this._enhancePromise(b)},_beforeSend:function(a,b){if(this._active===0){this._trigger("start");this._bitrateTimer=new this._BitrateTimer}this._active+=1;this._loaded+=b.uploadedBytes||0;this._total+=this._getTotal(b.files)},_onDone:function(a,
b,c,d){this._isXHRUpload(d)||this._onProgress(e.Event("progress",{lengthComputable:true,loaded:1,total:1}),d);d.result=a;d.textStatus=b;d.jqXHR=c;this._trigger("done",null,d)},_onFail:function(a,b,c,d){d.jqXHR=a;d.textStatus=b;d.errorThrown=c;this._trigger("fail",null,d);if(d.recalculateProgress){this._loaded-=d.loaded||d.uploadedBytes||0;this._total-=d.total||this._getTotal(d.files)}},_onAlways:function(a,b,c,d){this._active-=1;d.textStatus=b;if(c&&c.always){d.jqXHR=c;d.result=a}else{d.jqXHR=a;d.errorThrown=
c}this._trigger("always",null,d);if(this._active===0){this._trigger("stop");this._loaded=this._total=0;this._bitrateTimer=null}},_onSend:function(a,b){var c=this,d,f,h,g=c._getAJAXSettings(b),j=function(k,l){c._sending+=1;g._bitrateTimer=new c._BitrateTimer;return d=d||(k!==false&&c._trigger("send",a,g)!==false&&(c._chunkedUpload(g)||e.ajax(g))||c._getXHRPromise(false,g.context,l)).done(function(m,n,i){c._onDone(m,n,i,g)}).fail(function(m,n,i){c._onFail(m,n,i,g)}).always(function(m,n,i){c._sending-=
1;c._onAlways(m,n,i,g);if(g.limitConcurrentUploads&&g.limitConcurrentUploads>c._sending)for(m=c._slots.shift();m;){if(n=m.state?m.state()==="pending":!m.isRejected()){m.resolve();break}m=c._slots.shift()}})};this._beforeSend(a,g);if(this.options.sequentialUploads||this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending){if(this.options.limitConcurrentUploads>1){f=e.Deferred();this._slots.push(f);h=f.pipe(j)}else h=this._sequence=this._sequence.pipe(j,j);h.abort=function(){var k=
[undefined,"abort","abort"];if(!d){f&&f.rejectWith(h,k);return j(false,k)}return d.abort()};return this._enhancePromise(h)}return j()},_onAdd:function(a,b){var c=this,d=true,f=e.extend({},this.options,b),h=f.limitMultiFileUploads,g=this._getParamName(f),j,k,l;if(!(f.singleFileUploads||h)||!this._isXHRUpload(f)){k=[b.files];j=[g]}else if(!f.singleFileUploads&&h){k=[];j=[];for(l=0;l<b.files.length;l+=h){k.push(b.files.slice(l,l+h));f=g.slice(l,l+h);f.length||(f=g);j.push(f)}}else j=g;b.originalFiles=
b.files;e.each(k||b.files,function(m,n){var i=e.extend({},b);i.files=k?n:[n];i.paramName=j[m];i.submit=function(){return i.jqXHR=this.jqXHR=c._trigger("submit",a,this)!==false&&c._onSend(a,this)};return d=c._trigger("add",a,i)});return d},_replaceFileInput:function(a){var b=a.clone(true);e("<form></form>").append(b)[0].reset();a.after(b).detach();e.cleanData(a.unbind("remove"));this.options.fileInput=this.options.fileInput.map(function(c,d){if(d===a[0])return b[0];return d});if(a[0]===this.element[0])this.element=
b},_handleFileTreeEntry:function(a,b){var c=this,d=e.Deferred(),f=function(g){if(g&&!g.entry)g.entry=a;d.resolve([g])},h;b=b||"";if(a.isFile)if(a._file){a._file.relativePath=b;d.resolve(a._file)}else a.file(function(g){g.relativePath=b;d.resolve(g)},f);else if(a.isDirectory){h=a.createReader();h.readEntries(function(g){c._handleFileTreeEntries(g,b+a.name+"/").done(function(j){d.resolve(j)}).fail(f)},f)}else d.resolve([]);return d.promise()},_handleFileTreeEntries:function(a,b){var c=this;return e.when.apply(e,
e.map(a,function(d){return c._handleFileTreeEntry(d,b)})).pipe(function(){return Array.prototype.concat.apply([],arguments)})},_getDroppedFiles:function(a){a=a||{};var b=a.items;if(b&&b.length&&(b[0].webkitGetAsEntry||b[0].getAsEntry))return this._handleFileTreeEntries(e.map(b,function(c){var d;if(c.webkitGetAsEntry){d=c.webkitGetAsEntry();d._file=c.getAsFile();return d}return c.getAsEntry()}));return e.Deferred().resolve(e.makeArray(a.files)).promise()},_getSingleFileInputFiles:function(a){a=e(a);
var b=a.prop("webkitEntries")||a.prop("entries");if(b&&b.length)return this._handleFileTreeEntries(b);b=e.makeArray(a.prop("files"));if(!b.length){a=a.prop("value");if(!a)return e.Deferred().resolve([]).promise();b=[{name:a.replace(/^.*\\/,"")}]}return e.Deferred().resolve(b).promise()},_getFileInputFiles:function(a){if(!(a instanceof e)||a.length===1)return this._getSingleFileInputFiles(a);return e.when.apply(e,e.map(a,this._getSingleFileInputFiles)).pipe(function(){return Array.prototype.concat.apply([],
arguments)})},_onChange:function(a){var b=a.data.fileupload,c={fileInput:e(a.target),form:e(a.target.form)};b._getFileInputFiles(c.fileInput).always(function(d){c.files=d;b.options.replaceFileInput&&b._replaceFileInput(c.fileInput);b._trigger("change",a,c)!==false&&b._onAdd(a,c)})},_onPaste:function(a){var b=a.data.fileupload,c=a.originalEvent.clipboardData,d={files:[]};e.each(c&&c.items||[],function(f,h){(f=h.getAsFile&&h.getAsFile())&&d.files.push(f)});if(b._trigger("paste",a,d)===false||b._onAdd(a,
d)===false)return false},_onDrop:function(a){a.preventDefault();var b=a.data.fileupload,c=a.dataTransfer=a.originalEvent.dataTransfer,d={};b._getDroppedFiles(c).always(function(f){d.files=f;b._trigger("drop",a,d)!==false&&b._onAdd(a,d)})},_onDragOver:function(a){var b=a.data.fileupload,c=a.dataTransfer=a.originalEvent.dataTransfer;if(b._trigger("dragover",a)===false)return false;if(c)c.dropEffect="copy";a.preventDefault()},_initEventHandlers:function(){var a=this.options.namespace;if(this._isXHRUpload(this.options)){this.options.dropZone.bind("dragover."+
a,{fileupload:this},this._onDragOver).bind("drop."+a,{fileupload:this},this._onDrop);this.options.pasteZone.bind("paste."+a,{fileupload:this},this._onPaste)}this.options.fileInput.bind("change."+a,{fileupload:this},this._onChange)},_destroyEventHandlers:function(){var a=this.options.namespace;this.options.dropZone.unbind("dragover."+a,this._onDragOver).unbind("drop."+a,this._onDrop);this.options.pasteZone.unbind("paste."+a,this._onPaste);this.options.fileInput.unbind("change."+a,this._onChange)},
_setOption:function(a,b){var c=e.inArray(a,this._refreshOptionsList)!==-1;c&&this._destroyEventHandlers();e.Widget.prototype._setOption.call(this,a,b);if(c){this._initSpecialOptions();this._initEventHandlers()}},_initSpecialOptions:function(){var a=this.options;if(a.fileInput===undefined)a.fileInput=this.element.is('input[type="file"]')?this.element:this.element.find('input[type="file"]');else if(!(a.fileInput instanceof e))a.fileInput=e(a.fileInput);if(!(a.dropZone instanceof e))a.dropZone=e(a.dropZone);
if(!(a.pasteZone instanceof e))a.pasteZone=e(a.pasteZone)},_create:function(){var a=this.options;e.extend(a,e(this.element[0].cloneNode(false)).data());a.namespace=a.namespace||this.widgetName;this._initSpecialOptions();this._slots=[];this._sequence=this._getXHRPromise(true);this._sending=this._active=this._loaded=this._total=0;this._initEventHandlers()},destroy:function(){this._destroyEventHandlers();e.Widget.prototype.destroy.call(this)},enable:function(){var a=false;if(this.options.disabled)a=
true;e.Widget.prototype.enable.call(this);a&&this._initEventHandlers()},disable:function(){this.options.disabled||this._destroyEventHandlers();e.Widget.prototype.disable.call(this)},add:function(a){var b=this;if(!(!a||this.options.disabled))if(a.fileInput&&!a.files)this._getFileInputFiles(a.fileInput).always(function(c){a.files=c;b._onAdd(null,a)});else{a.files=e.makeArray(a.files);this._onAdd(null,a)}},send:function(a){if(a&&!this.options.disabled){if(a.fileInput&&!a.files){var b=this,c=e.Deferred(),
d=c.promise(),f,h;d.abort=function(){h=true;if(f)return f.abort();c.reject(null,"abort","abort");return d};this._getFileInputFiles(a.fileInput).always(function(g){if(!h){a.files=g;f=b._onSend(null,a).then(function(j,k,l){c.resolve(j,k,l)},function(j,k,l){c.reject(j,k,l)})}});return this._enhancePromise(d)}a.files=e.makeArray(a.files);if(a.files.length)return this._onSend(null,a)}return this._getXHRPromise(false,a&&a.context)}})});
