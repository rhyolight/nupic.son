(function(){function G(k,i,r,p){var b=this,z={datatype:H,viewrecords:true},v={edit:false,add:false,del:false,refreshtext:"Refresh",searchtext:"Filter",afterRefresh:function(){b.refreshData();b.jqgrid.object.trigger("reloadGrid")}};k=k;i=i;this.configuration=r;this.operations=p;this.jqgrid={id:null,object:null,options:null,last_selected_row:null,editable_columns:[],dirty_fields:{},pager:{id:null,options:null}};this.data={data:[],all_data:[],filtered_data:null};var x={enableDisableButtons:function(a){return function(c){function j(l){l=
jQuery("#"+a.jqgrid.id).jqGrid("getRowData",l);var d=l.key.toString(),f=/^<a\b[^>]*href="(.*?)" \b[^>]*>(.*?)<\/a>$/.exec(d);if(f!==null)d=f[2];var g=s.from(a.data.all_data).equals("columns.key",d).select()[0];if(a.jqgrid.dirty_fields[d]===undefined)a.jqgrid.dirty_fields[d]=[];var o=[],t=[];jQuery.each(l,function(m,q){q=q.toString();var A=/^<a\b[^>]*href="(.*?)" \b[^>]*>(.*?)<\/a>$/.exec(q);if(A!==null)q=A[2];A=g.columns[m];if(typeof A=="boolean")A=""+A;q!=A?o.push(m):t.push(m)});jQuery.each(o,function(m,
q){jQuery.inArray(q,a.jqgrid.dirty_fields[d])===-1&&a.jqgrid.dirty_fields[d].push(q)});jQuery.each(t,function(m,q){m=jQuery.inArray(q,a.jqgrid.dirty_fields[d]);m!==-1&&a.jqgrid.dirty_fields[d].splice(m,1)});a.jqgrid.dirty_fields[d].length===0&&delete a.jqgrid.dirty_fields[d];jQuery.each(a.operations.buttons,function(m,q){if(q.type==="post_edit"){m=jQuery("#"+a.jqgrid.id+"_buttonOp_"+q.id);if(F(a.jqgrid.dirty_fields))m.attr("disabled","disabled");else{m.click();m.removeAttr("disabled")}}});C()}var h=
a.jqgrid.object.jqGrid("getGridParam","multiselect")?"selarrrow":"selrow",e=a.jqgrid.object.jqGrid("getGridParam",h);e instanceof Array||(e=[e]);if(e.length===1)if(c&&c!==a.jqgrid.last_selected_row){jQuery("#"+a.jqgrid.id).restoreRow(a.jqgrid.last_selected_row);jQuery("#"+a.jqgrid.id).jqGrid("editRow",c,true,null,null,"clientArray",null,j);a.jqgrid.last_selected_row=c}jQuery.each(a.operations.buttons,function(l,d){l=jQuery("#"+a.jqgrid.id+"_buttonOp_"+d.id);if(d.type!=="post_edit")if(e.length>=d.real_bounds[0]&&
e.length<=d.real_bounds[1]){l.removeAttr("disabled");if(d.real_bounds[0]===1&&d.real_bounds[1]===1&&l.data("melange")!==undefined){var f=a.jqgrid.object.jqGrid("getRowData",e[0]);f=s.from(a.data.all_data).equals("columns.key",f.key).select()[0];var g=l.data("melange").click;l.click(g(f.operations.buttons[d.id].link));l.attr("value",f.operations.buttons[d.id].caption)}}else l.attr("disabled","disabled")})}}(b),global_button_functions:{redirect_simple:function(a){return a.new_window?function(){window.open(a.link)}:
function(){window.location.href=a.link}},redirect_custom:function(a){return function(c){return a.new_window?function(){window.open(c)}:function(){window.location.href=c}}},post:function(a){return function(){var c=n.get(a.idx).jqgrid.object.jqGrid("getGridParam","multiselect")?"selarrrow":"selrow";c=n.get(a.idx).jqgrid.object.jqGrid("getGridParam",c);c instanceof Array||(c=c===null?[]:[c]);var j=[];if(!(c.length<a.real_bounds[0]||c.length>a.real_bounds[1])){jQuery.each(c,function(h,e){var l=jQuery("#"+
n.get(a.idx).jqgrid.id).jqGrid("getRowData",e);s.from(n.get(a.idx).all_data).equals("columns.key",l.key).select();var d={};jQuery.each(a.keys,function(f,g){f=l[g];if(jQuery(f).hasClass("listsnoul"))f=/^<a\b[^>]*>(.*?)<\/a>$/.exec(f)[1];d[g]=f});j.push(d)});if(a.url==="")a.url=window.location.href;jQuery.post(a.url,{xsrf_token:window.xsrf_token,idx:a.idx,button_id:a.button_id,data:JSON.stringify(j)},function(h){if(a.redirect=="true")try{var e=JSON.parse(h);if(e.data.url!==undefined)window.location.href=
e.data.url}catch(l){}h=parseInt(a.refresh,10);if(!isNaN(h)){n.get(h).refreshData();jQuery("#"+n.get(h).jqgrid.id).trigger("reloadGrid")}if(a.refresh=="current"){n.get(a.idx).refreshData();jQuery("#"+n.get(a.idx).jqgrid.id).trigger("reloadGrid")}else if(a.refresh=="all"){h=n.getAll();jQuery.each(h,function(d,f){f.refreshData();jQuery("#"+n.get(d).jqgrid.id).trigger("reloadGrid")})}})}}},post_edit:function(a){return function(){var c=n.get(a.idx).jqgrid,j={};if(!(c.editable_columns.length===0&&F(c.dirty_fields))){c.object.jqGrid("getGridParam",
"records");for(var h=c.object.jqGrid("getGridParam","reccount"),e=1;e<=h;e++){var l=jQuery("#"+c.id).jqGrid("getRowData",e),d=l.key.toString(),f=/^<a\b[^>]*href="(.*?)" \b[^>]*>(.*?)<\/a>$/.exec(d);if(f!==null)d=f[2];if(c.dirty_fields[d]!==undefined){j[d]={};jQuery.each(c.dirty_fields[d],function(g,o){g=l[o].toString();var t=/^<a\b[^>]*href="(.*?)" \b[^>]*>(.*?)<\/a>$/.exec(g);if(t!==null)g=t[2];j[d][o]=g});a.keys!==undefined&&jQuery.each(a.keys,function(g,o){if(j[d][o]===undefined){g=l[o].toString();
var t=/^<a\b[^>]*href="(.*?)" \b[^>]*>(.*?)<\/a>$/.exec(g);if(t!==null)g=t[2];j[d][o]=g}})}}if(a.url==="")a.url=window.location.href;jQuery.post(a.url,{xsrf_token:window.xsrf_token,idx:a.idx,button_id:a.button_id,data:JSON.stringify(j)},function(g){if(a.redirect=="true")try{var o=JSON.parse(g);if(o.data.url!==undefined)window.location.href=o.data.url}catch(t){}g=parseInt(a.refresh,10);if(!isNaN(g)){n.get(g).refreshData();jQuery("#"+n.get(g).jqgrid.id).trigger("reloadGrid")}if(a.refresh=="current"){n.get(a.idx).refreshData();
jQuery("#"+n.get(a.idx).jqgrid.id).trigger("reloadGrid")}else if(a.refresh=="all"){g=n.getAll();jQuery.each(g,function(m,q){q.refreshData();jQuery("#"+n.get(m).jqgrid.id).trigger("reloadGrid")})}})}}}},row_functions:{redirect_custom:function(a){return function(c,j){return a.new_window||j.which===2||j.which===1&&j.ctrlKey?function(){window.open(c)}:function(){window.location.href=c}}}}},E=function(){jQuery("#"+k).replaceWith(['<p id="temporary_list_placeholder_',i,'"></p>','<table id="'+b.jqgrid.id+
'"',' cellpadding="0" cellspacing="0"></table>','<div id="'+b.jqgrid.pager.id+'"',' style="text-align:center"></div>'].join(""))},D=function(){var a="",c=0;jQuery("#load_"+b.jqgrid.id).show();var j=function(){var h="?";if(window.location.href.indexOf("?")!==-1)h="&";jQuery.ajax({async:true,cache:false,url:[window.location.href,h,"fmt=json&limit=150",a===""?"":"&start="+a,"&idx=",i].join(""),timeout:6E4,tryCount:1,retryLimit:5,error:function(e){if(e.status==500){this.tryCount++;if(this.tryCount<=this.retryLimit)jQuery.ajax(this);
else{jQuery("#temporary_list_placeholder_"+i).html('<span style="color:red">Error retrieving data: please refresh the list or the whole page to try again</span>');jQuery("#load_"+b.jqgrid.id).hide()}}else{jQuery("#temporary_list_placeholder_"+i).html('<span style="color:red">Error retrieving data: please refresh the list or the whole page to try again</span>');jQuery("#load_"+b.jqgrid.id).hide()}},success:function(e){var l=e.next==="done";if(e.data[a]!==undefined){if(b.configuration===null)b.configuration=
e.configuration;if(b.operations===null)b.operations=e.operations;jQuery.each(e.data[a],function(){b.data.data.push(this.columns);b.data.all_data.push(this)});b.jqgrid.object===null?y():b.jqgrid.object.trigger("reloadGrid");if(l){jQuery("#temporary_list_placeholder_"+i).remove();jQuery("#load_"+b.jqgrid.id).hide()}else{a=e.next;setTimeout(j,100);c++}}if(l){jQuery("#temporary_list_placeholder_"+i).remove();jQuery("#load_"+b.jqgrid.id).hide();jQuery("#"+b.jqgrid.id)[0].triggerToolbar();jQuery.each(b.configuration.colModel,
function(d,f){f.editable!==undefined&&f.editable===true&&b.jqgrid.editable_columns.push(f.name)});jQuery("#t_"+b.jqgrid.id).children().remove();b.operations!==undefined&&b.operations.buttons!==undefined&&jQuery.each(b.operations.buttons,function(d,f){d=b.jqgrid.id+"_buttonOp_"+f.id;var g=jQuery("<input type='button' value='"+f.caption+"' style='float:left' id='"+d+"'/>").button();jQuery("#t_"+b.jqgrid.id).append(g);f.parameters.idx=i;if(f.type!=="post_edit"){f.real_bounds=f.bounds;g=f.real_bounds.indexOf("all");
if(g!==-1)f.real_bounds[g]=b.jqgrid.object.jqGrid("getGridParam","records");f.parameters.real_bounds=f.real_bounds}if(f.type==="post_edit"||f.real_bounds[0]>0)jQuery("#"+d).attr("disabled","disabled");f.parameters.button_id=f.id;jQuery("#"+d).click(x.global_button_functions[f.type](f.parameters));f.type=="redirect_custom"&&jQuery("#"+d).data("melange",{click:x.global_button_functions[f.type](f.parameters)})});jQuery("#t_"+b.jqgrid.id).css("padding-bottom","3px");jQuery("#t_"+b.jqgrid.id).append("<input type='button' value='CSV Export' style='float:right;' id='csvexport_"+
b.jqgrid.id+"'/>");jQuery("#csvexport_"+b.jqgrid.id).button();jQuery("#csvexport_"+b.jqgrid.id).click(function(){var d=[];d[0]=[];if(b.data.data[0]!==undefined||b.data.filtered_data[0]!==undefined){var f=b.data.filtered_data||b.data.data;jQuery.each(b.configuration.colNames,function(o,t){o=t;o=o.replace(/\"|&quot;|&#34;/g,'""');if(o.indexOf(",")!==-1||o.indexOf('"')!==-1||o.indexOf("\r\n")!==-1)o='"'+o+'"';d[0].push(o)});d[0]=d[0].join(",");var g=[];jQuery.each(b.configuration.colModel,function(o,
t){g.push(t.name)});jQuery.each(f,function(o,t){d[d.length]=[];jQuery.each(g,function(m,q){m=t[q];if(m===null)m="";if(m===undefined)m="";m=m.toString();q=/^<a\b[^>]*href="(.*?)" \b[^>]*>(.*?)<\/a>$/.exec(m);if(q!==null)m=q[1];m=m.replace(/\"|&quot;|&#34;/g,'""');if(m.indexOf(",")!==-1||m.indexOf('"')!==-1||m.indexOf("\r\n")!==-1)m='"'+m+'"';d[d.length-1].push(m)});d[d.length-1]=d[d.length-1].join(",")});d=d.join("\r\n");jQuery("#csv_dialog").remove();jQuery("body").append(["<div id='csv_dialog' style='display:none'>  <h3>Now you can copy and paste CSV data from the text area to a new file:</h3>  <textarea style='width:450px;height:250px'>",
d,"</textarea></div>"].join(""));jQuery("#csv_dialog").dialog({height:420,width:500,modal:true,buttons:{Close:function(){jQuery(this).dialog("close")}}})}});jQuery("#t_"+b.jqgrid.id).append("<div style='float:right;margin-right:4px;'><input type='checkbox' id='regexp_"+b.jqgrid.id+"'/>RegExp Search</div>");jQuery("#regexp_"+b.jqgrid.id).click(function(){jQuery("#"+b.jqgrid.id).jqGrid().trigger("reloadGrid")});e=jQuery.Event("melange_list_loaded");e.list_object=b;b.jqgrid.object.trigger(e);e=jQuery("#gview_"+
b.jqgrid.id+" .ui-jqgrid-bdiv");e.width(e.width()+1)}}})};setTimeout(j,100)};this.refreshData=function(){b.data={data:[],all_data:[],filtered_data:null};D()};var w=new (function(){var a=function(h){var e={hidden_columns:{}};jQuery.each(h,function(l,d){e.hidden_columns[d.name]=d.hidden});return e},c=function(h,e){return{sort_settings:{sortname:h,sortorder:e}}},j=function(h,e){var l={filters:{}};e._search===true&&jQuery.each(h,function(d,f){if(e[f.name]!==undefined)l.filters[f.name]=e[f.name]});return l};
this.saveCurrentTableConfiguration=function(){var h=u.cookie.getCookie(u.cookie.MELANGE_USER_PREFERENCES),e=b.jqgrid.object.jqGrid("getGridParam","colModel"),l=b.jqgrid.object.jqGrid("getGridParam","sortname"),d=b.jqgrid.object.jqGrid("getGridParam","sortorder"),f=b.jqgrid.object.jqGrid("getGridParam","postData"),g=a(e);g=jQuery.extend(c(l,d),g);g=jQuery.extend(j(e,f),g);e={lists_configuration:{}};e.lists_configuration[i]=g;e.lists_configuration=jQuery.extend(h.lists_configuration,e.lists_configuration);
u.cookie.saveCookie(u.cookie.MELANGE_USER_PREFERENCES,e,14,window.location.pathname)};this.getPreviousTableConfiguration=function(h){var e=u.cookie.getCookie(u.cookie.MELANGE_USER_PREFERENCES),l=h.colModel;if(e.lists_configuration[i]!==undefined){jQuery.each(e.lists_configuration[i].hidden_columns,function(g,o){g=s.from(l).equals("name",g).select()[0]||null;if(g!==null)g.hidden=o});if(e.lists_configuration[i].sort_settings!==undefined){var d=e.lists_configuration[i].sort_settings.sortname,f=e.lists_configuration[i].sort_settings.sortorder;
if(s.from(l).equals("name",d).select()[0]!==undefined?true:false){h.sortname=d;h.sortorder=f}}e.lists_configuration[i].filters!==undefined&&jQuery.each(e.lists_configuration[i].filters,function(g,o){g=s.from(l).equals("name",g).select()[0];if(g!==undefined)g.searchoptions={defaultValue:o}})}return h}}),C=function(){if(b.configuration.footerrow){var a={},c=b.jqgrid.object;jQuery.each(b.configuration.colModel,function(j,h){if(h.summaryType!==undefined){j=c.jqGrid("getCol",h.name,false,h.summaryType);
a[h.name]=h.summaryTpl.replace(/\{0\}/ig,j)}});c.jqGrid("footerData","set",a)}},B=function(){if(b.jqgrid.object){C();w.saveCurrentTableConfiguration()}},y=function(){b.configuration=w.getPreviousTableConfiguration(b.configuration);var a=jQuery.extend(b.configuration,{postData:{my_index:i},onSelectAll:x.enableDisableButtons,onSelectRow:x.enableDisableButtons,gridComplete:B}),c={caption:"Columns",buttonicon:"ui-icon-calculator",onClickButton:function(){jQuery("#"+b.jqgrid.id).setColumns({colnameview:false,
jqModal:true,ShrinkToFit:true,afterSubmitForm:w.saveCurrentTableConfiguration,recreateForm:true});return false},position:"last",title:"Show/Hide Columns",cursor:"pointer"};jQuery("#"+b.jqgrid.id).jqGrid(jQuery.extend(b.jqgrid.options,a)).jqGrid("navGrid","#"+b.jqgrid.pager.id,b.jqgrid.pager.options,{},{},{},{closeAfterSearch:true,multipleSearch:true},{}).jqGrid("navButtonAdd","#"+b.jqgrid.pager.id,c);jQuery("#"+b.jqgrid.id).jqGrid("filterToolbar",{beforeSearch:w.saveCurrentTableConfiguration,searchOnEnter:false,
autosearch:true});jQuery("#load_"+b.jqgrid.id).closest("div").css("line-height","100%");jQuery("#load_"+b.jqgrid.id).html("<img src='/soc/content/"+u.config.app_version+"/images/jqgrid_loading.gif'></img>");b.jqgrid.object=jQuery("#"+b.jqgrid.id)};this.getDiv=function(){return k};this.getIdx=function(){return i};(function(){jQuery(function(){if(jQuery("#"+k).length===0)throw new u.error.divNotExistent("Div "+k+" is not existent");b.jqgrid.id="jqgrid_"+k;b.jqgrid.pager.id="jqgrid_pager_"+k;b.jqgrid.options=
jQuery.extend(z,{pager:"#"+b.jqgrid.pager.id});b.jqgrid.pager.options=v;n.add(b);E();y();D()})})()}if(window.melange===undefined)throw new Error("Melange not loaded");var u=window.melange;if(window.jLinq===undefined)throw new Error("jLinq not loaded");var s=window.jLinq;u.list=window.melange.list=function(){return new u.list};var I=u.logging.debugDecorator(u.list);u.error.createErrors(["listIndexNotValid","divNotExistent","indexAlreadyExistent"]);var F=function(k){for(var i in k)return false;return true},
H=function(k){var i=k.my_index,r=n.get(i).data.data,p=r,b="",z={eq:{method:"equals",not:false},ne:{method:"equals",not:true},lt:{method:"less",not:false},le:{method:"lessEquals",not:false},gt:{method:"greater",not:false},ge:{method:"greaterEquals",not:false},bw:{method:"startsWith",not:false},bn:{method:"startsWith",not:true},ew:{method:"endsWith",not:false},en:{method:"endsWith",not:true},cn:{method:"contains",not:false},nc:{method:"contains",not:true},"in":{method:"match",not:false},ni:{method:"match",
not:true}};if(k._search&&k.filters){var v=JSON.parse(k.filters);if(v.rules[0].data!==""){b=v.groupOp;if(b==="OR")p={};jQuery.each(v.rules,function(a,c){if(c.op==="in"||c.op==="ni")c.data=c.data.split(",").join("|");p=z[c.op].not?b==="OR"?s.from(p).union(s.from(r).not()[z[c.op].method](c.field,c.data).select()).select():s.from(p).not()[z[c.op].method](c.field,c.data).select():b==="OR"?s.from(p).union(s.from(r)[z[c.op].method](c.field,c.data).select()).select():s.from(p)[z[c.op].method](c.field,c.data).select()})}}else r[0]!==
undefined&&jQuery.each(r[0],function(a){if(k[a]!==undefined){var c=jQuery("#regexp_"+n.get(i).jqgrid.id).is(":checked"),j=false;jQuery.each(n.get(i).configuration.colModel,function(h,e){if(e.editoptions!==undefined&&a===e.name)j=true});p=c||j?s.from(p).match(a,k[a]).select():s.from(p).contains(a,k[a]).select()}});var x=k.sidx;v=k.sord;jQuery.each(n.get(i).configuration.colModel,function(a,c){if(c.name===x&&(c.sorttype==="integer"||c.sorttype==="int"))jQuery.each(p,function(j,h){j=parseInt(h[x],10);
isNaN(j)||(h[x]=j)})});v=v==="asc"?"":"-";if(p.length>0)p=s.from(p).ignoreCase().orderBy(v+x).select();n.get(i).data.filtered_data=p;if(k.rows===-1)k.rows=n.get(i).data.filtered_data.length;v=(k.page-1)*k.rows;for(var E=k.page*k.rows-1,D={page:k.page,total:p.length===0?0:Math.ceil(p.length/k.rows),records:p.length,rows:[]},w=v;w<=E;w++)if(p[w]!==undefined){var C=[];r[0]!==undefined&&jQuery.each(n.get(i).configuration.colModel,function(a,c){var j;a=n.get(i).data.all_data;for(var h=0;h<a.length;h++)if(a[h].columns.key===
p[w].key){j=a[h];break}a=p[w][c.name];if(j.operations!==undefined&&j.operations.row!==undefined&&j.operations.row.link!==undefined){c=c.editable||false;if(a!==null&&a!==undefined&&!c&&a.toString().match(/<a\b[^>]*>.*<\/a>/)===null)a='<a style="display:block;" href="'+j.operations.row.link+'" class="listsnoul">'+a+"</a>"}C.push(a)});D.rows.push({key:p[w].key,cell:C})}var B=jQuery("#"+n.get(i).jqgrid.id);B[0].addJSONData(D);var y=n.get(i).configuration.colModel;jQuery.each(y,function(a,c){if(c.extra!==
undefined){var j=0,h=0;jQuery.each(c.extra,function(e,l){k[e]===l&&j++;h++});if(j!==h){y[a].hidden=true;y[a].hidedlg=true;B.jqGrid("getColProp",c.name).hidedlg=true;B.jqGrid("hideCol",c.name)}else{y[a].hidden=false;y[a].hidedlg=false;B.jqGrid("getColProp",c.name).hidedlg=false;B.jqGrid("showCol",c.name)}}})},n=function(){var k=[];return{add:function(i){k[i.getIdx()]=i},get:function(i){return k[i]!==undefined?k[i]:null},getAll:function(){return jQuery.extend({},k)},isExistent:function(i){return k[i]!==
undefined?true:false}}}();I.loadList=function(k,i,r){r=parseInt(r,10);i=JSON.parse(i);if(isNaN(r)||r<0)throw new u.error.listIndexNotValid("List index "+r+" is not valid");if(n.isExistent(r))throw new u.error.indexAlreadyExistent("Index "+r+" is already existent");new G(k,r,i.configuration,i.operations)}})();
