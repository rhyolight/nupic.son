{% extends "v2/modules/gsoc/base.html" %}
{% comment %}
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
{% endcomment %}

{% block stylesheets %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" media="screen" href="/soc/content/{{ app_version }}/css/v2/gsoc/forms.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="/soc/content/{{ app_version }}/css/v2/gsoc/uniform.default.css" />
{% endblock stylesheets %}

{% block page_content %}

{% if proposal_ignored %}
  <div id="user-message" class="error">
    <strong>ALERT:</strong> This proposal has been flagged as
    <strong>ignored</strong> by
    {% if user_role == 'proposer' %}
      the organization administrators. You will <strong>NOT</strong> be
      allowed to update or withdraw the proposal now. If you think this is
      incorrect, contact your organization administrators to resolve this
      situation.
    {% else %}{% if user_role == 'mentor' %}
      the organization administrators. You will <strong>NOT</strong> be
      allowed to perform any action on this proposal now. If you think this
      is incorrect, contact your organization administrators to resolve this
      situation.
    {% else %}{% if user_role == 'org_admin' %}
      you or one of the other administrators of your organization. Neither
      will the student be able to update or withdraw this proposal nor the
      mentors of your organization will be able to perform any action on
      this proposal. If you think this is incorrect, please click the
      <strong>Unignore</strong> button below to resolve this situation.
      <strong>NOTE:</strong> You will need to refresh this page after
      clicking the Unignore button, to perform any further actions on this
      proposal.
    {% endif %}{% endif %}{% endif %}
  </div>
{% endif %}


<!--  TODO: Remove the following if block once the JS magic to remove
      the buttons of action is in place -->
{% if not proposal_ignored and user_role == 'org_admin' %}
  <div id="user-message" class="error">
    <strong>NOTE: </strong>If you click the <strong>Ignore this proposal
    </strong> button below, please be sure to refresh the page before
    performing any further action on this proposal.
  </div>
{% endif %}

<h1 id="project-page-title">
  {{ proposal.title }}
  {% if update_link and not proposal_ignored %}
    <span class="action-link">
      <a href="{{ update_link }}">Update</a>
    </span>
  {% endif %}
</h1>
<h2 id="project-page-student-name">{{ student_name }}</h2>

{% if duplicate %}
  {{ duplicate.render }}
{% endif %}

{{ publicly_visible_button.render }}

{{ withdraw_proposal_button.render }}

{{ ignore_proposal_button.render }}

{{ accept_proposal_button.render }}

{{ proposal_modification_button.render }}

{{ wish_to_mentor_button.render }}

{{ assign_mentor.render }}


<div class="project-short">
  {% if public_comments_visible %}
    <p class="project-mentor"><strong>Email:</strong> {{ student_email }}</p>
  {% endif %}
  {% if private_comments_visible %}
  <p class="project-mentor"><strong>Mentor:</strong> {{ mentor.name|default:"No mentor assigned" }}</p>
  <p class="project-possible-mentor"><strong>Possible mentors: </strong>{{ possible_mentors|default:"None" }}</p>
  {% endif %}
  <p class="description"><strong>Short description:</strong> {{ proposal.abstract }}</p>
  <p class="status"><strong>Status:</strong> {{ proposal.status }}</p>
  {% if additional_info %}
  <p class="description"><strong>Additional info:</strong>
    <a href="{{ additional_info_link }}"> {{ additional_info }}</a>
  </p>
  {% endif %}
</div>

<div class="project-long">
{{ proposal.content|safe }}
</div>

{% if scoring_visible %}
<div class="score">
  <div class="score-average">
    <strong>Average score:</strong>
    <div id="score-average-stars" class="stars"></div>
    <div id="score-average-desc">
      <em>{{ scores.average }}/{{ max_score }} out of {{ scores.number }} users, total: {{ scores.total }}</em>
    </div>
  </div>
  <div class="score-add">
    <strong>My score:</strong>
    <div id="score-add-stars" class="stars"></div>
  </div>
</div>
{% endif %}

{% if public_comments_visible %}
<div class="project-comment-container">
  {% if private_comments_visible %}
  <div class="project-comment-box project-comment-private-container">
    <a name="private-comments"></a><h3>{{ private_comments|length }} private comments</h3>
    {% for comment in private_comments %}
      <div class="project-comment-single" id="c{{ comment.key.id_or_name }}">
        <p class="project-comment-meta"><strong>{{ comment.author.name }}</strong> <a href="#c{{ comment.key.id_or_name }}">{{ comment.created }}</a></p>
        {{ comment.content|safe }}
      </div>
    {% endfor %}
  </div>
  {% endif %}
  <div class="project-comment-box project-comment-public-container">
    <a name="comments"></a><h3>{{ public_comments|length }} comments</h3>
    {% for comment in public_comments %}
      <div class="project-comment-single" id="c{{ comment.key.id_or_name }}">
        <p class="project-comment-meta"><strong>{{ comment.author.name }}</strong> <a href="#c{{ comment.key.id_or_name }}">{{ comment.created }}</a></p>
        {{ comment.content|safe }}
      </div>
    {% endfor %}
  </div>
  <!-- begin comment form -->
  <a name="comment"></a>
  <form action="{{ comment_box.action }}" method="post" id="form" class="form-project-comment">
  {{ comment_box.form.render }}
  </form>
  <!-- end comment form -->
</div>
{% endif %}
{% endblock page_content %}

{% block synchronous_scripts %}
  <script type='text/javascript' src="/tiny_mce/tiny_mce.js"></script>
  {{ block.super }}
{% endblock synchronous_scripts %}
{% block dependencies %}
  [
  dep.uniform,
  dep.jqueryui.dialog,
  null,
  css("/soc/content/{{ app_version }}/css/v2/gsoc/tables.css"),
  css("/soc/content/{{ app_version }}/css/v2/gsoc/proposal.css"),
  {% if scoring_visible %}
  dep.raty,
  {% endif %}
  function () {
    /* Apply Uniform CSS to form fields. */
    jQuery("select, input:radio, input:file, input:checkbox").uniform();

    {% if public_comments_visible %}
      tinyMCE.init(melange.tinyMceConfig(["content"]));
    {% endif %}
    {% if scoring_visible %}
      var initialTotal = {{ scores.total }};
      var initialNumber = {{ scores.number }};
      var userInitialScore = {{ scores.user_score }};
      var maxScore = {{ max_score }};

      var successHandler = function (userScore) {
        userScore = parseInt(userScore);
        var newTotal = (initialTotal - userInitialScore + userScore);

        var newNumber = initialNumber;
        /* the user did not score */
        if (!userInitialScore && userScore) {
          newNumber++;
        }
        /* the user removed his or her score */
        if (userInitialScore && !userScore) {
          newNumber--;
        }

        var newAverage;
        var newMessage;
        if (!newNumber) {
          newAverage = 0;
          newMessage = 'No scores yet';
        } else {
          newAverage = Math.floor(newTotal / newNumber);
          newMessage = newAverage + '/' + maxScore + ' out of ' + newNumber + ' users, total: ' + newTotal;
        }
        jQuery.fn.raty.start(newAverage, '#score-average-stars');
        jQuery('#score-average-desc em').html(newMessage);
      };
    {% endif %}

    jQuery(document).ready(function() {
      {% if scoring_visible %}
        jQuery('#score-average-stars').raty({
          number: maxScore,
          readOnly:   true,
          start:      {{ scores.average }},
          half:	    true,
          path:       '/soc/content/' + melange.config.app_version + '/images/v2/gsoc',
          starHalf:   'proposal-rate-star-half.png',
          starOff:    'proposal-rate-star-off.png',
          starOn:     'proposal-rate-star-on.png',
        });
      {% endif %}

      var buttonObj = function (button_id, post_url, init_state, msgs) {
        this.button_id = button_id;
        this.post_url = post_url;
        this.state = init_state;
        this.enable_btn_disabled_msg = $('<div></div>')
            .html("<p><strong>" + msgs.enable + "</strong></p>")
            .dialog({
                autoOpen: false,
                title: 'Button Disabled'
        });
        this.disable_btn_disabled_msg = $('<div></div>')
            .html("<p><strong>" + msgs.disable + "</strong></p>")
            .dialog({
                autoOpen: false,
                title: 'Button Disabled'
        });
        var self_obj = this;

        this.click = function () {
          jQuery("#" + this.button_id + "-enable").click(function() {
            if (self_obj.is_enabled()) {
              self_obj.flip_buttons();
            } else {
              self_obj.enable_btn_disabled_msg.dialog('open');
            }
          });
          jQuery("#" + this.button_id + "-disable").click(function() {
            if (self_obj.is_enabled()) {
              self_obj.disable_btn_disabled_msg.dialog('open');
            } else {
              self_obj.flip_buttons();
            }
          });
        }
        this.flip_state = function () {
          if (this.state == "enable") {
            this.state = "disable";
          } else if (this.state == "disable") {
            this.state = "enable";
          }
        }
        this.is_enabled = function () {
          if (this.state == "enable") {
            return true;
          } else if (this.state == "disable") {
            return false;
          }
        }
        this.flip_buttons = function () {
          jQuery.post(this.post_url,
              {value: this.state, xsrf_token: window.xsrf_token},
              function(data) {
            if (self_obj.is_enabled()) {
              jQuery("#"+self_obj.button_id+"-enable").addClass("disabled");
              jQuery("#"+self_obj.button_id+"-disable").removeClass("disabled");
            } else {
              jQuery("#"+self_obj.button_id+"-disable").addClass("disabled");
              jQuery("#"+self_obj.button_id+"-enable").removeClass("disabled");
            }
            self_obj.flip_state();
          });
        }
      }

      /* Make the ignore proposal button, post using ajax. */
      {% if user_role == "org_admin" %}
      var ignore_proposal_button = new buttonObj(
          "{{ ignore_proposal_button.id }}",
          "{{ ignore_proposal_button.link }}",
          "{{ ignore_proposal_button.state }}",
          {"enable":
              "{{ ignore_proposal_button.enable_btn_disabled_msg }}",
          "disable":
              "{{ ignore_proposal_button.disable_btn_disabled_msg }}"})
          .click();

      /* Make the accept proposal button, post using ajax. */
      var accept_proposal_button = new buttonObj(
          "{{ accept_proposal_button.id }}",
          "{{ accept_proposal_button.link }}",
          "{{ accept_proposal_button.state }}",
          {"enable":
              "{{ accept_proposal_button.enable_btn_disabled_msg }}",
          "disable":
              "{{ accept_proposal_button.disable_btn_disabled_msg }}"})
          .click();
      {% endif %}

      {% if user_role == "mentor" %}
      /* Make allow proposal modifications button, post using ajax. */
      var proposal_modification_button = new buttonObj(
          "{{ proposal_modification_button.id }}",
          "{{ proposal_modification_button.link }}",
          "{{ proposal_modification_button.state }}",
          {"enable":
              "{{ proposal_modification_button.enable_btn_disabled_msg }}",
          "disable":
              "{{ proposal_modification_button.disable_btn_disabled_msg }}"})
          .click();

      /* Make the wish to mentor button, post using ajax. */
      var wish_to_mentor_button = new buttonObj(
          "{{ wish_to_mentor_button.id }}",
          "{{ wish_to_mentor_button.link }}",
          "{{ wish_to_mentor_button.state }}",
          {"enable":
              "{{ wish_to_mentor_button.enable_btn_disabled_msg }}",
          "disable":
              "{{ wish_to_mentor_button.disable_btn_disabled_msg }}"})
          .click();
      {% endif %}

      {% if user_role == "proposer" %}
      /* Make the publicly visible button, post using ajax. */
      var publicly_visible_button = new buttonObj(
          "{{ publicly_visible_button.id }}",
          "{{ publicly_visible_button.link }}",
          "{{ publicly_visible_button.state }}",
          {"enable":
              "{{ publicly_visible_button.enable_btn_disabled_msg }}",
          "disable":
              "{{ publicly_visible_button.disable_btn_disabled_msg }}"})
          .click();
      var withdraw_proposal_button = new buttonObj(
          "{{ withdraw_proposal_button.id }}",
          "{{ withdraw_proposal_button.link }}",
          "{{ withdraw_proposal_button.state }}",
          {"enable":
              "{{ withdraw_proposal_button.enable_btn_disabled_msg }}",
          "disable":
              "{{ withdraw_proposal_button.disable_btn_disabled_msg }}"})
          .click();
      {% endif %}
    });

    {% if scoring_visible %}
      hintList = [];
      for(var i = 0; i < maxScore; i++) {
        hintList[i] = '' + (i + 1) + ' star(s)';
      }

      $('#score-add-stars').raty({
          cancel: true,
          cancelPlace:'right',
          cancelOff: 'proposal-rate-cancel-off.png',
          cancelOn: 'proposal-rate-cancel-on.png',
          cancelHint: 'Remove my rating',
          click: function (value) {
              jQuery.post("{{ score_action }}", {value: value, xsrf_token: window.xsrf_token});
              successHandler(value)
          },
          half:		false,
          path:       '/soc/content/' + melange.config.app_version + '/images/v2/gsoc',
          number: maxScore,
          start:      {{ scores.user_score }},
          starHalf:   'proposal-rate-star-half.png',
          starOff:    'proposal-rate-star-off.png',
          starOn:     'proposal-rate-star-on.png',
          hintList:   hintList
      });
    {% endif %}
  }
  ]
{% endblock dependencies %}
